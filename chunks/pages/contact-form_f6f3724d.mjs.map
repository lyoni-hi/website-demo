{"version":3,"file":"contact-form_f6f3724d.mjs","sources":["../../../src/pages/contact-form.ts"],"sourcesContent":["import type { APIRoute } from \"astro\";\nimport { getEnv } from \"../scripts-ssr/env\";\n\nfunction isNonEmptyString(value: unknown): value is string {\n    return typeof value === \"string\" && value.length > 0;\n}\n\nexport const put: APIRoute = async ({ request, locals }) => {\n    const data = await request.formData();\n    const name = data.get(\"name\");\n    const email = data.get(\"email\");\n    const message = data.get(\"message\");\n\n    if (!isNonEmptyString(name) || !isNonEmptyString(message))\n        return new Response(null, {\n            status: 400,\n        });\n\n    const header = `**From ${name.trim()} ${\n        isNonEmptyString(email) ? `<${email.trim()}>` : \"\"\n    }**`;\n\n    const text = message.trim();\n    const content = header + \"\\n\\n\" + text;\n\n    if (header.length > 2000 || content.length > 10_500)\n        return new Response(null, { status: 400 });\n\n    const msgData = {\n        allowed_mentions: {\n            parse: [],\n        },\n        content: content.length > 2000 ? header : content,\n    };\n\n    const payload = new FormData();\n    payload.set(\"payload_json\", JSON.stringify(msgData));\n\n    if (text.length > 2000)\n        payload.set(\n            \"files[0]\",\n            new Blob([text], { type: \"text/plain\" }),\n            \"message.txt\"\n        );\n\n    const url = new URL(getEnv(locals, import.meta.env, \"CONTACT_WEBHOOK\"));\n    url.searchParams.set(\"wait\", \"true\");\n\n    const res = await fetch(url, {\n        method: \"POST\",\n        body: payload,\n    });\n\n    if (!res.ok) {\n        console.error(\n            \"Error while executing contact webhook:\",\n            res.status,\n            \"\\n\" + (await res.text().catch(() => \"Unknown error\"))\n        );\n\n        return new Response(\"Failed to post message\", {\n            status: 502,\n        });\n    }\n\n    return new Response(null, {\n        status: 201,\n    });\n};\n"],"names":[],"mappings":"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"}